<!DOCTYPE html>
<html>
<head>
  <title>MiniScope - Fast Capture</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    canvas {
      width: 100%;
      max-width: 800px;
      height: 300px;  /* increase a bit */
      display: block;
      margin: 20px auto;
    }
    button { margin: 10px; padding: 10px 20px; font-size: 16px; }
    #status { font-weight: bold; margin-top: 10px; }
  </style>
</head>
<body>
  <h1>ðŸ“¡ MiniScope Fast Capture</h1>
  <button onclick="startCapture()">ðŸ“· Start Capture</button>
  <div id="status">Status: Ready</div>
  <canvas id="chart"></canvas>

  <script>
    const socket = io('/scope');
    const V_REF = 3.3;
    const SAMPLE_PERIOD_US = 0.333; // 3 MSPS

    const ctx = document.getElementById('chart').getContext('2d');
    const chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [{
          label: 'Voltage (V)',
          data: [],
          borderColor: 'red',
          borderWidth: 1,
          pointRadius: 0.1,
          tension: 0.1
        }]
      },
      options: {
        animation: false,
        responsive: true,
        scales: {
          x: {
            title: { display: true, text: 'Time (Âµs)' },
            ticks: { autoSkip: true, maxTicksLimit: 10 }
          },
          y: {
            title: { display: true, text: 'Voltage (V)' },
            min: 0,
            max: V_REF
          }
        }
      }
    });

    function startCapture() {
      document.getElementById('status').innerText = "Status: Triggering capture...";
      chart.data.labels = [];
      chart.data.datasets[0].data = [];
      chart.update();
      socket.emit('start_trigger');
    }

    socket.on('done', async () => {
      document.getElementById('status').innerText = "Status: Downloading data...";

      const res = await fetch('/capture.bin');
      const buf = await res.arrayBuffer();
      const view = new DataView(buf);

      const data = [];
      const labels = [];
      const sampleCount = buf.byteLength / 2;  // number of 16-bit samples

      for (let i = 0; i < buf.byteLength; i += 2) {
        const raw = view.getUint16(i, true);  // little-endian
        data.push((raw / 4095.0) * 3.3);
        labels.push((i / 2) * 0.333);  // sample index * sample period in Âµs
      }

      chart.data.labels = labels;
      chart.data.datasets[0].data = data;
      chart.update();
      console.log("First 10 data points:", data.slice(0,10));
      console.log("First 10 labels:", labels.slice(0,10));
      document.getElementById('status').innerText = `Status: Done. Received ${sampleCount} samples.`;
    });


    socket.on('connect', () => {
      console.log("Connected to server via WebSocket!");
    });
  </script>
</body>
</html>
